<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WooCommerce AI Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background: #f8f9fa; font-family: 'Inter', system-ui, sans-serif; }
    header { background: #0d6efd; color: #fff; padding: 18px 0; text-align: center; border-radius: 8px; margin-bottom: 18px; }
    .btn-custom { border-radius: 10px; font-weight: 600; }
    #output { background: #fff; padding: 18px; border-radius: 10px; box-shadow: 0 6px 18px rgba(16,24,40,0.06); min-height: 220px; }
    thead th { background: #0b5ed7; color: #fff; }
    .small-muted { color: #6b7280; font-size: 13px; }
    .loading { text-align:center; padding:30px 0; color:#0d6efd; font-weight:600; }
    .nowrap { white-space: nowrap; }
  </style>
</head>
<body>

<div class="container py-4">
  <header>
    <h3 class="mb-0">🛒 WooCommerce AI Dashboard</h3>
    <div class="small-muted">Click a button or type a command to fetch data</div>
  </header>

  <!-- ✅ New Input Box -->
  <div class="row g-3 mb-3">
    <div class="col-12">
      <input type="text" id="search-box" class="form-control"
        placeholder='🔍 Type command e.g. "show last order", "show best selling product", "show all orders"'>
    </div>
  </div>

  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <button class="btn btn-primary w-100 btn-custom" id="btn-best">🏆 Show Best Selling Product</button>
    </div>
    <div class="col-md-4">
      <button class="btn btn-success w-100 btn-custom" id="btn-orders">📋 Show All Orders</button>
    </div>
    <div class="col-md-4">
      <button class="btn btn-warning w-100 btn-custom" id="btn-last">🆕 Show Last Order</button>
    </div>
  </div>

  <div id="output">
    <p class="text-muted mb-0">Select a button above or type a command to display data.</p>
  </div>
</div>

<script>
  // ✅ Backend URL
  const API_BASE = "http://127.0.0.1:8000"; // Change if deployed

  // Button Events
  document.getElementById('btn-best').addEventListener('click', () => fetchAndRender('/api/products/best-selling'));
  document.getElementById('btn-orders').addEventListener('click', () => fetchAndRender('/api/orders'));
  document.getElementById('btn-last').addEventListener('click', () => fetchAndRender('/api/orders/last'));

  // ✅ Input Box Event (Command Based)
  document.getElementById('search-box').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const cmd = e.target.value.trim().toLowerCase();

      if (cmd.includes("last order")) {
        fetchAndRender('/api/orders/last');
      } 
      else if (cmd.includes("best selling")) {
        fetchAndRender('/api/products/best-selling');
      } 
      else if (cmd.includes("all orders")) {
        fetchAndRender('/api/orders');
      } 
      else {
        document.getElementById('output').innerHTML = `<div class="alert alert-info">❓ Unknown command: ${escapeHtml(cmd)}</div>`;
      }
    }
  });

  // Fetch & Render Function
  async function fetchAndRender(endpoint) {
    const output = document.getElementById('output');
    output.innerHTML = `<div class="loading">Loading…</div>`;

    try {
      const res = await fetch(`${API_BASE}${endpoint}`, { 
        method: "GET",
        headers: { "Accept": "application/json" }
      });

      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const payload = await res.json();

      if (!payload.success) {
        output.innerHTML = `<div class="alert alert-danger">${payload.error || 'No data'}</div>`;
        return;
      }

      // 📌 Last Order
      if (endpoint === '/api/orders/last') {
        const o = payload.data;
        output.innerHTML = `
          <h5 class="mb-3">🆕 Last Order</h5>
          <div class="row">
            <div class="col-md-6"><b>Order ID:</b> <span class="nowrap">${o.id}</span></div>
            <div class="col-md-6"><b>Status:</b> ${o.status}</div>
            <div class="col-md-6 mt-2"><b>Customer:</b> ${o.billing_first_name || '—'} ${o.billing_last_name || ''}</div>
            <div class="col-md-6 mt-2"><b>Total:</b> ${o.total || '0.00'}</div>
            <div class="col-12 mt-3 small-muted"><b>Date:</b> ${o.date || '—'}</div>
          </div>
        `;
        return;
      }

      // 📌 Best Selling Product (Single Object)
      if (endpoint === '/api/products/best-selling') {
        const p = payload.data;
        output.innerHTML = `
          <h5 class="mb-3">🏆 Best Selling Product</h5>
          <div class="row">
            <div class="col-md-6"><b>Product ID:</b> ${p.product_id}</div>
            <div class="col-md-6"><b>Name:</b> ${p.product_name}</div>
            <div class="col-md-6 mt-2"><b>Quantity Sold:</b> ${p.quantity_sold}</div>
            <div class="col-md-6 mt-2"><b>Total Sales:</b> ${p.total_sales}</div>
          </div>
        `;
        return;
      }

      // 📌 Orders Table
      const list = payload.data;
      if (!Array.isArray(list) || list.length === 0) {
        output.innerHTML = `<div class="alert alert-warning">No results found.</div>`;
        return;
      }

      const keys = Object.keys(list[0]);
      let html = `<div class="table-responsive"><table class="table table-striped table-hover"><thead><tr>`;
      for (const k of keys) html += `<th>${k}</th>`;
      html += `</tr></thead><tbody>`;
      for (const row of list) {
        html += `<tr>`;
        for (const k of keys) {
          let cell = row[k] ?? '';
          if (typeof cell === 'string' && cell.length > 120) cell = cell.slice(0, 120) + '…';
          html += `<td>${escapeHtml(String(cell))}</td>`;
        }
        html += `</tr>`;
      }
      html += `</tbody></table></div>`;
      output.innerHTML = html;

    } catch (err) {
      output.innerHTML = `<div class="alert alert-danger">Error: ${escapeHtml(err.message)}</div>`;
    }
  }

  // HTML Escape
  function escapeHtml(s) {
    return s.replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
</script>

</body>
</html>
